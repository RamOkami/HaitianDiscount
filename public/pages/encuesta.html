<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tu Opini√≥n | HaitianDiscount</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js" type="module"></script>
    
    <style>
        :root {
            --primary-color: #2563eb; 
            --success-color: #10b981; 
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --text-main: #333;
            --bg-light: #ffffff;
            --bg-darker: #f7f7f7;
            --border-color: #e5e7eb;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-darker);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            background: var(--bg-light);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 100%;
            text-align: center;
        }

        h1 {
            color: var(--primary-color);
            font-size: 24px;
            margin-bottom: 10px;
        }

        p.subtitle {
            font-size: 16px;
            color: #6b7280;
            margin-bottom: 25px;
        }

        .rating-display {
            font-size: 48px;
            margin: 20px 0;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 15px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 14px;
            color: white;
            margin-bottom: 20px;
        }

        #feedback-form {
            text-align: left;
            margin-top: 20px;
        }

        #comment {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-sizing: border-box;
            resize: vertical;
            font-family: 'Inter', sans-serif;
        }

        button {
            width: 100%;
            padding: 12px;
            background-color: var(--success-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #059669; 
        }
    </style>
</head>
<body>

<div class="container">
    <div id="loader" style="display: none;">
        <p>Cargando...</p>
    </div>
    <div id="feedback-content" style="display: none;">
        <h1>Valoraci√≥n de Servicio</h1>
        <p class="subtitle">Pedido #<span id="order-id-display">...</span></p>

        <div class="rating-box">
            <div id="rating-stars" class="rating-display"></div>
            <div id="rating-status" class="status-badge"></div>
        </div>

        <form id="feedback-form">
            <label for="comment" style="display: block; margin-bottom: 8px; font-weight: 600;">¬øQu√© te pareci√≥ nuestro servicio?</label>
            <textarea id="comment" placeholder="D√©janos tus comentarios aqu√≠. (Opcional)"></textarea>
            
            <button type="submit" id="submit-btn">Enviar Opini√≥n</button>
        </form>
    </div>

    <div id="success-message" style="display: none; padding: 40px 0;">
        <h1>¬°Gracias por tu Feedback! ‚úÖ</h1>
        <p class="subtitle">Tu opini√≥n ha sido registrada con √©xito. Ayuda a HaitianDiscount a mejorar.</p>
        <button onclick="window.close();" style="background-color: var(--primary-color);">Cerrar Ventana</button>
    </div>
    
</div>

<script type="module">
    import { ref, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
    // üí° IMPORTANTE: Aseg√∫rate de que 'config.js' exporte tu instancia de Realtime Database: 'db'
    import { db } from '../assets/js/config.js'; 

    const urlParams = new URLSearchParams(window.location.search);
    const orderId = urlParams.get('order');
    let rating = urlParams.get('rating'); 

    const feedbackContent = document.getElementById('feedback-content');
    const successMessage = document.getElementById('success-message');
    const ratingStars = document.getElementById('rating-stars');
    const ratingStatus = document.getElementById('rating-status');
    const orderIdDisplay = document.getElementById('order-id-display');
    const feedbackForm = document.getElementById('feedback-form');
    const submitBtn = document.getElementById('submit-btn');

    if (!orderId || !rating) {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Par√°metros de pedido y calificaci√≥n faltantes.',
        });
        document.getElementById('loader').style.display = 'none';
        
    } else {
        rating = parseInt(rating);
        orderIdDisplay.textContent = orderId;
        feedbackContent.style.display = 'block';

        // Estilos y texto seg√∫n la calificaci√≥n inicial
        switch (rating) {
            case 5:
                ratingStars.textContent = '‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê';
                ratingStatus.textContent = '¬°Excelente Experiencia!';
                ratingStatus.style.backgroundColor = 'var(--success-color)';
                break;
            case 3:
                ratingStars.textContent = '‚≠ê‚≠ê‚≠ê';
                ratingStatus.textContent = 'Experiencia Normal';
                ratingStatus.style.backgroundColor = 'var(--warning-color)';
                break;
            case 1:
                ratingStars.textContent = '‚≠ê';
                ratingStatus.textContent = 'Experiencia Negativa';
                ratingStatus.style.backgroundColor = 'var(--error-color)';
                break;
            default:
                ratingStars.textContent = 'N/A';
                ratingStatus.textContent = 'Calificaci√≥n Desconocida';
                ratingStatus.style.backgroundColor = '#6b7280';
                break;
        }

        // Listener para el formulario
        feedbackForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            submitBtn.disabled = true;
            submitBtn.textContent = 'Enviando...';

            const comment = document.getElementById('comment').value.trim();
            const timestamp = new Date().toISOString();

            try {
                // RUTA DONDE SE GUARDA EL FEEDBACK EN FIREBASE
                const feedbackRef = ref(db, `ordenes/${orderId}/feedback`);

                await update(feedbackRef, {
                    rating: rating,
                    comment: comment,
                    fecha_feedback: timestamp,
                    feedback_recibido: true
                });

                feedbackContent.style.display = 'none';
                successMessage.style.display = 'block';

            } catch (error) {
                console.error("Error al guardar el feedback en Firebase:", error);
                Swal.fire('Error', 'No se pudo registrar tu opini√≥n. Int√©ntalo m√°s tarde.', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Enviar Opini√≥n';
            }
        });
    }
</script>

</body>
</html>